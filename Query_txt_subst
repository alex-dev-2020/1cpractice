
&НаКлиенте
Процедура СоздатьДокументРеализации(Команда)
	
	//Забираем парметры с формы
	
	Склад = ЭтаФорма.Склад;
	ВидЦены = ЭтаФорма.ВидЦены;
	
	//Вызываем сееверную процедуру, передаем параметры
	
	СоздатьДокументРеализацииНаСервере(Склад,ВидЦены);
	
КонецПроцедуры

&НаСервере
Процедура СоздатьДокументРеализацииНаСервере(ТекущийСклад,ВыбранныйВидЦены)
	// Вставить содержимое обработчика.
	
	МассивВидовНоменклатуры = Новый Массив;
	
	Если ЭтаФорма.ЭтоТовар Тогда
		МассивВидовНоменклатуры.Добавить(Перечисления.ВидыНоменклатуры.Товар)
		
	КонецЕсли;
	
	Если ЭтаФорма.ЭтоОсобыйТовар Тогда 
		
		МассивВидовНоменклатуры.Добавить(Перечисления.ВидыНоменклатуры.ОсобыйТовар)
		
	КонецЕсли;
	
	ЗапросОтатковТоваровПоСкладу = Новый Запрос;
	
	ЗапросОтатковТоваровПоСкладу.Текст = 
	"ВЫБРАТЬ
	|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	|	ТоварыНаСкладахОстатки.Номенклатура.ВидНоменклатуры КАК НоменклатураВидНоменклатуры,
	|	&Цена КАК ЦенаРеализации,
	|	ТоварыНаСкладахОстатки.Склад КАК Склад,
	|	ТоварыНаСкладахОстатки.КоличествоОстаток КАК Количество
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки КАК ТоварыНаСкладахОстатки
	|ГДЕ
	|	ТоварыНаСкладахОстатки.Номенклатура.ВидНоменклатуры В(&МассивВидовНоменклатуры)
	|	И ТоварыНаСкладахОстатки.Склад = &ТекущийСклад
	|	И ТоварыНаСкладахОстатки.КоличествоОстаток > 0";
	
	
	ЗапросОтатковТоваровПоСкладу.УстановитьПараметр("МассивВидовНоменклатуры", МассивВидовНоменклатуры);
	ЗапросОтатковТоваровПоСкладу.УстановитьПараметр("ТекущийСклад", ТекущийСклад);
	
	
	Если ВыбранныйВидЦены = "ЦенаЗакупочная" Тогда
		
		ЗапросОтатковТоваровПоСкладу.Текст = СтрЗаменить(ЗапросОтатковТоваровПоСкладу.Текст,"&Цена", "ТоварыНаСкладахОстатки.Номенклатура.ЦенаЗакупочная");
		
	ИначеЕсли ВыбранныйВидЦены = "ЦенаПоступления"  Тогда 
		
		ЗапросОтатковТоваровПоСкладу.Текст = СтрЗаменить(ЗапросОтатковТоваровПоСкладу.Текст,"&Цена","ТоварыНаСкладахОстатки.Номенклатура.ЦенаПоступления");
		
	КонецЕсли;
	
	
	РезультатЗапроса = ЗапросОтатковТоваровПоСкладу.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выгрузить();
	
	//Сообщить("ЗапросОтатковТоваровПоСкладу выполнен");
	Документ = Документы.РеализацияТоваров.СоздатьДокумент();
	
	Документ.Дата = ТекущаяДата();
	Документ.Склад = ТекущийСклад;
	Документ.Товары.Загрузить(ВыборкаДетальныеЗаписи);
	
	РасчетНеобходим = ПолучитьЗначениеКонстантыРасчетСтоимости();
	
	
	Если РасчетНеобходим = Истина Тогда 
		
		РасчетСтоимостиТоваровТЧ(Документ);
		
	Иначе 
		
		Сообщить("Автоматический расчет стоимости отключен!")
		
	КонецЕсли;
	
	Если ЭтаФорма.СразуПроводитьДокумент Тогда 
		Документ.Записать(РежимЗаписиДокумента.Проведение);
		Сообщить("Проведен документ реализации "  + Документ.Номер);
	Иначе 	
		Документ.Записать();
		
	КонецЕсли;
	
	Сообщить("Создан документ реализации "  + Документ.Номер);
	
	
КонецПроцедуры

&НаСервере
Функция ПолучитьЗначениеКонстантыРасчетСтоимости()
	
	ДаНет = Константы.РассчитыватьСтоимостьАвтоматически.Получить();
	Возврат ДаНет ;
	
КонецФункции


&НаСервере
Процедура РасчетСтоимостиТоваровТЧ(Документ) 
	
	
	ТЧДокумента = Документ.Товары;
	
	Для Каждого Элемент из ТЧДокумента  Цикл 
		
		Массив = РасчетСтоимости(Элемент.ЦенаРеализации, Элемент.Количество);
		
		Элемент.Стоимость = Массив[0];
		Элемент.Скидка = Массив[1];
		Элемент.СтоимостьСоСкидкой = Массив[2];
		
	КонецЦикла;
	
	
КонецПроцедуры


&НаСервере 
Функция РасчетСтоимости (Цена, Количество) 
	
	Стоимость = Цена * Количество;
	
	Скидка= 0;
	
	Если Стоимость >= 1000 И Стоимость < 5000 Тогда 
		
		Скидка = 0.01 * Стоимость;
		
	ИначеЕсли  Стоимость > 5000 Тогда 
		
		Скидка = 0.02 * Стоимость;
		
		
	КонецЕсли;
	
	СтоимостьСоСкидкой = Стоимость - Скидка ; 
	
	Массив  = Новый Массив;
	
	Массив.Добавить(Стоимость); //Массив [0]
	Массив.Добавить(Скидка); //Массив [1]
	Массив.Добавить(СтоимостьСоСкидкой); //Массив [2]
	
	
	Возврат Массив;
	
КонецФункции



